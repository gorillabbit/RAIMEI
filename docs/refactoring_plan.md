## cline-cli リファクタリング詳細計画 (イベント駆動アーキテクチャ中心)

### リファクタリングの目的

-   プログラム全体をより根本的にシンプルにし、可読性、保守性、拡張性を向上させる。
-   AI の自律性を高め、人間からのフィードバックを極力不要にする。

### 基本方針

-   **イベント駆動アーキテクチャ (案 3) を中心に採用:** 処理の流れをイベントによって駆動し、AI の自律的なタスク実行を可能にする。
-   **グローバル状態の削減と関数型アプローチ (案 1) を導入:** 状態管理をシンプルにし、コードの予測可能性とテスト容易性を向上させる。
-   **モジュール分割と依存関係の整理 (案 2) を実施:** コードのモジュール性を高め、保守性と拡張性を向上させる。

### 詳細計画

#### 1. イベント駆動アーキテクチャの導入 (案 3)

-   **1.1. イベント定義:** アプリケーション内で発生する主要なイベントを定義します。

    | イベント名                 | 説明                                                          |
    | :------------------------- | :------------------------------------------------------------ |
    | `TaskStartedEvent`         | タスクが開始された                                            |
    | `APIRequestNeededEvent`    | API リクエストが必要になった                                  |
    | `ToolExecutionNeededEvent` | ツールの実行が必要になった                                    |
    | `APIRequestExecutedEvent`  | API リクエストが実行された (結果を含む)                       |
    | `ToolExecutedEvent`        | ツールが実行された (結果を含む)                               |
    | `ResultEvaluatedEvent`     | 処理結果が AI によって評価された (次のアクションの決定を含む) |
    | `TaskCompletedEvent`       | タスクが正常に完了した                                        |
    | `TaskFailedEvent`          | タスクが失敗した                                              |
    | `NotificationNeededEvent`  | ユーザーへの通知が必要になった (例: タスク完了、エラー発生)   |

-   **1.2. イベントバスの実装:** イベントの発行と購読を管理するシンプルな Event Bus を実装します。

    -   例: `EventEmitter` を利用したシンプルな実装、または RxJS などのライブラリの導入を検討。
    -   `EventBus.emit(eventName, payload)`: イベントを発行する関数
    -   `EventBus.on(eventName, handler)`: イベントを購読する関数

-   **1.3. `lifecycle.ts` のリファクタリング:** `lifecycle.ts` をイベント駆動型に書き換えます。

    -   `startTask` 関数: `TaskStartedEvent` を発行するように変更。
    -   `resumeTaskFromHistory` 関数: タスク再開処理をイベントとして定義し、発行するように変更。
    -   `initiateTaskLoop` 関数: イベントループとして再構築し、イベントをトリガーに処理を進めるように変更。

-   **1.4. `processClineRequests` のリファクタリング:** `processClineRequests` および関連関数をイベントハンドラーとして再構築します。

    -   `APIRequestNeededEvent` ハンドラー: API リクエストを実行し、`APIRequestExecutedEvent` を発行。
    -   `ToolExecutionNeededEvent` ハンドラー: ツールを実行し、`ToolExecutedEvent` を発行。
    -   `ResultEvaluatedEvent` ハンドラー: AI による結果評価ロジックを実装し、次のイベント (`TaskCompletedEvent`, `TaskFailedEvent`, `APIRequestNeededEvent`, `ToolExecutionNeededEvent` など) を発行。

-   **1.5. 状態管理の見直し:** タスクの状態をイベントを通じて管理するように変更します。

    -   グローバル状態 (`globalStateManager`) の利用を段階的に削減し、イベントペイロードまたはイベントハンドラー内で必要な状態を管理するように変更。
    -   状態の永続化 (保存・ロード) もイベントとして定義し、イベントハンドラー内で処理するように検討。

#### 2. グローバル状態の削減と関数型アプローチの導入 (案 1)

-   **2.1. `globalStateManager` の利用状況調査:** `globalStateManager` がどこでどのように利用されているかを調査し、依存箇所をリストアップします。
-   **2.2. 状態の局所化:** `globalStateManager` で管理されている状態を、必要なスコープ (関数、モジュールなど) に локализовать します。
    -   関数の引数として状態を渡すように変更。
    -   モジュール内で状態を閉じる (private 変数など)。
-   **2.3. 純粋関数の導入:** 副作用を伴う関数を純粋関数に置き換えられるか検討します。
-   **2.4. Reducer パターンの適用:** 状態変更ロジックを Reducer 関数に集約し、状態の変更をより予測可能にします (必要に応じて)。
-   **2.5. `globalStateManager` の削除:** すべての依存箇所を修正後、`globalStateManager` を削除します。

#### 3. モジュール分割と依存関係の整理 (案 2)

-   **3.1. モジュール構造の分析:** 現在のモジュール構造 (`src/api/`, `src/chat/`, `src/tools/`, `src/integrations/` など) を分析し、各モジュールの責務と依存関係を明確にします。
-   **3.2. モジュール再編:** イベント駆動アーキテクチャに基づいて、より適切なモジュール分割を検討します。
    -   例: `event/`, `task/`, `api/`, `tool/`, `ai/`, `integration/` など、機能と責務が明確になるように再編。
-   **3.3. 依存関係の整理:** モジュール間の依存関係を分析し、循環依存や不要な依存関係を解消します。
    -   インターフェースを明確に定義し、モジュール間の結合度を弱めます。
    -   必要に応じて、util 関数などを共通モジュール (`src/shared/utils/` など) に移動します。
-   **3.4. インポートパスの修正:** モジュール再編に合わせて、import 文のパスを修正します。

### 実装順序

1.  **イベント駆動アーキテクチャの導入 (案 3):** イベント定義、Event Bus 実装、`lifecycle.ts` リファクタリング、`processClineRequests` リファクタリング、状態管理見直し (1.1 - 1.5)。
2.  **グローバル状態の削減と関数型アプローチの導入 (案 1):** `globalStateManager` 利用状況調査、状態の局所化、純粋関数の導入、Reducer パターンの適用、`globalStateManager` 削除 (2.1 - 2.5)。
3.  **モジュール分割と依存関係の整理 (案 2):** モジュール構造分析、モジュール再編、依存関係整理、インポートパス修正 (3.1 - 3.4)。

### スケジュール (概算)

-   **イベント駆動アーキテクチャ導入:** 2-3 週間
-   **グローバル状態削減と関数型アプローチ導入:** 1-2 週間
-   **モジュール分割と依存関係整理:** 1 週間

### 次のステップ

上記詳細計画をご確認いただき、特に実装順序やスケジュール感について、ご意見や修正点があればお聞かせください。

計画に問題がなければ、**イベント駆動アーキテクチャの導入** から実装に着手します。
